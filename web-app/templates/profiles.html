<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeroShare Profiles - IPO Pilot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/cyberpunk.css">
</head>
<body>
    <div class="scan-lines"></div>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard"><i class="bi bi-rocket-takeoff"></i> IPO Pilot</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/dashboard/profiles">Profiles</a></li>
                    <li class="nav-item"><a class="nav-link" href="/dashboard/ipos">IPOs</a></li>
                    <li class="nav-item"><a class="nav-link" href="/dashboard/applications">Applications</a></li>
                    <li class="nav-item"><a class="nav-link" href="/dashboard/settings">Settings</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2><i class="bi bi-person-circle"></i> MeroShare Profiles</h2>
                <p class="text-muted">Manage your MeroShare account profiles for IPO applications</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-cyber" data-bs-toggle="modal" data-bs-target="#addProfileModal">
                    <i class="bi bi-plus-circle"></i> Add New Profile
                </button>
            </div>
        </div>

        <!-- Trial Warning -->
        <div id="trial-alert" class="alert alert-info d-none" role="alert">
            <i class="bi bi-clock-history"></i> You are on 7-day free trial. <span id="trial-days"></span> days remaining.
            <a href="/pricing" class="alert-link">Subscribe to continue after trial.</a>
        </div>

        <!-- Profiles List -->
        <div class="row" id="profilesList">
            <div class="col-12 text-center text-muted">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">No profiles yet. Create one to start applying to IPOs.</p>
            </div>
        </div>

        <!-- Add Profile Modal -->
        <div class="modal fade" id="addProfileModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark">
                    <div class="modal-header border-bottom-0">
                        <h5 class="modal-title glow-text">Add MeroShare Profile</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addProfileForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label cyber-label">Profile Name</label>
                                        <input type="text" class="form-control cyber-input" id="profileName" placeholder="e.g., Personal Account" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label cyber-label">DPID</label>
                                        <input type="text" class="form-control cyber-input" id="dpid" placeholder="Demat Participant ID" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label cyber-label">BOID</label>
                                        <input type="text" class="form-control cyber-input" id="boid" placeholder="Beneficial Owner ID" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label cyber-label">Password</label>
                                        <input type="password" class="form-control cyber-input" id="meroPassword" placeholder="MeroShare password" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label cyber-label">CRN</label>
                                        <input type="text" class="form-control cyber-input" id="crn" placeholder="Citizenship Registration No" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label cyber-label">Transaction PIN</label>
                                        <input type="password" class="form-control cyber-input" id="transactionPin" placeholder="Your transaction PIN" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label cyber-label">Default Bank ID</label>
                                        <select class="form-control cyber-input" id="bankId" required>
                                            <option value="">Select Bank</option>
                                            <option value="1">Nepal Investment Bank</option>
                                            <option value="2">Nabil Bank</option>
                                            <option value="3">Nepali Bank</option>
                                            <option value="4">Standard Chartered Bank</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label cyber-label">Default Kittas</label>
                                        <input type="number" class="form-control cyber-input" id="defaultKittas" value="10" min="1" max="100" required>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-warning">
                                <i class="bi bi-shield-check"></i> Your credentials are encrypted and never stored in plain text.
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-cyber" onclick="submitProfile()">Create Profile</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function loadProfiles() {
            fetch('/dashboard/profiles')
                .then(r => r.text())
                .then(html => {
                    const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
                    if (profiles.length > 0) {
                        let profilesHTML = '';
                        profiles.forEach((p, i) => {
                            profilesHTML += `
                                <div class="col-md-4 mb-4">
                                    <div class="cyber-card p-4">
                                        <h5 class="glow-text">${p.name}</h5>
                                        <p class="text-muted"><small>DPID: ${p.dpid}</small></p>
                                        <p class="text-muted"><small>BOID: ${p.boid}</small></p>
                                        <div class="btn-group w-100" role="group">
                                            <button class="btn btn-sm btn-cyber" onclick="editProfile(${i})">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteProfile(${i})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        document.getElementById('profilesList').innerHTML = profilesHTML;
                    }
                });
            
            // Check trial status
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const trialAlert = document.getElementById('trial-alert');
            if (user.trial) {
                trialAlert.classList.remove('d-none');
                document.getElementById('trial-days').textContent = user.trial.days_remaining;
            }
        }

        function submitProfile() {
            const formData = {
                name: document.getElementById('profileName').value,
                dpid: document.getElementById('dpid').value,
                boid: document.getElementById('boid').value,
                password: document.getElementById('meroPassword').value,
                crn: document.getElementById('crn').value,
                transaction_pin: document.getElementById('transactionPin').value,
                default_bank_id: parseInt(document.getElementById('bankId').value),
                default_kittas: parseInt(document.getElementById('defaultKittas').value)
            };

            fetch('/dashboard/profiles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Profile created successfully!');
                    loadProfiles();
                    document.getElementById('addProfileForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addProfileModal')).hide();
                }
            })
            .catch(e => alert('Error: ' + e.message));
        }

        function deleteProfile(id) {
            if (confirm('Delete this profile?')) {
                fetch(`/dashboard/profiles/${id}`, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.error) alert('Error: ' + data.error);
                        else loadProfiles();
                    });
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }

        loadProfiles();
    </script>
</body>
</html>
